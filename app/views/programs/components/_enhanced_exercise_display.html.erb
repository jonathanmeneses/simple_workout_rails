<!-- Enhanced Exercise Display with Auto-substitution -->
<% status = exercise_substitution_status(workout_exercise, available_equipment) %>
<% display_name = get_display_exercise_name(workout_exercise, available_equipment) %>
<% substitutes = workout_exercise.exercise.find_substitutes(available_equipment, 5) %>

<%= turbo_frame_tag "exercise_#{workout_exercise.exercise.id}_substitution" do %>
  <div class="flex items-center justify-between w-full">
    <div class="flex-1">
      <!-- Exercise name with visual indicators -->
      <div class="exercise-display">
        <h4 class="<%= case status[:type]
                       when :auto then 'text-lg font-medium text-orange-700'
                       when :manual then 'text-lg font-medium text-blue-700 italic'
                       when :unavailable then 'text-lg font-medium text-red-600'
                       else 'text-lg font-medium text-gray-900'
                       end %>">
          <%= display_name %>
        </h4>

        <!-- Substitution info -->
        <% if status[:type] != :none %>
          <div class="substitution-info mt-1 flex items-center gap-2">
            <!-- Status indicator -->
            <% case status[:type] %>
            <% when :auto %>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800">
                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9 5a1 1 0 012 0v.064a3.042 3.042 0 01.592.296c.487.246.918.573 1.2.967.283.394.208.954-.126 1.264a.93.93 0 01-1.314 0c-.197-.197-.197-.518 0-.715.197-.197.518-.197.715 0 .197.197.197.518 0 .715-.197.197-.518.197-.715 0a.93.93 0 01-.126-1.264c.282-.394.713-.721 1.2-.967A3.042 3.042 0 0111 5.064V5z" clip-rule="evenodd"/>
                </svg>
                Auto-substituted
              </span>
            <% when :manual %>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                </svg>
                Manual selection
              </span>
            <% when :unavailable %>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <%= status[:reason] %>
              </span>
            <% end %>

            <!-- Original exercise info -->
            <% if status[:type] == :auto || status[:type] == :manual %>
              <span class="text-xs text-gray-500">
                Originally: <span class="font-medium text-gray-700"><%= status[:original] %></span>
              </span>
            <% end %>
          </div>
        <% end %>

        <!-- Equipment requirements indicator -->
        <% if workout_exercise.exercise.equipment_required.present? %>
          <div class="equipment-info mt-1">
            <div class="text-xs text-gray-500">
              Requires: 
              <% missing_equipment = workout_exercise.exercise.equipment_required - available_equipment %>
              <% workout_exercise.exercise.equipment_required.each_with_index do |eq, index| %>
                <span class="<%= missing_equipment.include?(eq) ? 'text-red-600 font-medium' : 'text-gray-600' %>">
                  <%= eq.humanize %><%= index < workout_exercise.exercise.equipment_required.length - 1 ? ', ' : '' %>
                </span>
              <% end %>
            </div>
          </div>
        <% else %>
          <div class="equipment-info mt-1">
            <div class="text-xs text-green-600">
              No equipment needed
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Substitute button -->
    <% if substitutes.any? || status[:type] == :auto %>
      <div class="flex items-center gap-2 ml-3">
        <%= form_with url: program_path(@program), method: :get, local: false,
                      data: { turbo_frame: "program_content" },
                      class: "inline" do |f| %>
          <%= f.hidden_field :view_mode, value: @view_mode %>
          <%= f.hidden_field :cycle, value: @selected_cycle %>
          <% @selected_equipment.each do |eq| %>
            <%= f.hidden_field :equipment, value: eq, multiple: true %>
          <% end %>
          
          <!-- Hidden fields for other substitutions to maintain state -->
          <% if params[:substitutions] %>
            <% params[:substitutions].each do |ex_id, sub_name| %>
              <% unless ex_id == workout_exercise.exercise.id.to_s %>
                <%= f.hidden_field "substitutions[#{ex_id}]", value: sub_name %>
              <% end %>
            <% end %>
          <% end %>

          <!-- Calculate next substitute -->
          <% if status[:type] == :auto %>
            <!-- For auto-substituted exercises, cycling should go: original -> auto -> manual alternatives -->
            <% manual_substitute = params[:substitutions]&.dig(workout_exercise.exercise.id.to_s) %>
            <% if manual_substitute.blank? %>
              <!-- Currently showing auto, next should be original -->
              <% next_exercise = workout_exercise.exercise.name %>
            <% else %>
              <!-- Currently showing manual selection, cycle through alternatives -->
              <% current_index = substitutes.find_index { |s| s.name == manual_substitute } || -1 %>
              <% next_index = (current_index + 1) % substitutes.length %>
              <% next_exercise = substitutes[next_index].name %>
            <% end %>
          <% else %>
            <!-- Standard cycling for manual substitutions -->
            <% current_index = current_substitution_index(workout_exercise.exercise.id, substitutes, workout_exercise.exercise.name) %>
            <% next_index = (current_index + 1) % (substitutes.length + 1) %>
            <% next_exercise = next_index == 0 ? workout_exercise.exercise.name : substitutes[next_index - 1].name %>
          <% end %>
          
          <%= f.hidden_field "substitutions[#{workout_exercise.exercise.id}]", value: next_exercise %>
          
          <button type="submit" 
                  class="flex items-center gap-1 px-3 py-1 text-sm <%= 
                    case status[:type]
                    when :auto then 'text-orange-600 hover:text-orange-800 hover:bg-orange-50'
                    when :manual then 'text-blue-600 hover:text-blue-800 hover:bg-blue-50'
                    when :unavailable then 'text-red-600 hover:text-red-800 hover:bg-red-50'
                    else 'text-blue-600 hover:text-blue-800 hover:bg-blue-50'
                    end
                  %> rounded transition-colors">
            <!-- Swap icon -->
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
            </svg>
            <span>
              <% case status[:type] %>
              <% when :auto %>
                <%= manual_substitute.blank? ? 'Use Original' : 'Next' %>
              <% when :manual %>
                Next
              <% when :unavailable %>
                Try Alternative
              <% else %>
                Substitute
              <% end %>
            </span>
          </button>
        <% end %>
        
        <!-- Substitute count indicator -->
        <div class="text-xs text-gray-400">
          <%= pluralize(substitutes.count, 'option') %>
        </div>
      </div>
      
    <% else %>
      <!-- No substitutes available indicator -->
      <% if available_equipment != Exercise::VALID_EQUIPMENT %>
        <div class="text-xs text-red-600 ml-3 flex items-center gap-1">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          No alternatives
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>