<% case @view_mode %>
<% when 'description' %>
  <div class="space-y-6">
    <div>
      <h3 class="font-semibold text-lg mb-3">Program Overview</h3>
      <p class="text-gray-700 mb-4"><%= @program.description %></p>
      
      <h4 class="font-medium mb-2">Program Structure:</h4>
      <ul class="space-y-1 mb-4">
        <% @program.workout_cycles.first&.workout_sessions&.each do |session| %>
          <li class="flex items-center gap-2 text-gray-700">
            <span class="text-blue-500">•</span> <%= session.name %>
          </li>
        <% end %>
      </ul>
      
      <h4 class="font-medium mb-2">Training Cycles:</h4>
      <ul class="space-y-1">
        <% @program.workout_cycles.each do |cycle| %>
          <li class="flex items-center gap-2 text-gray-700">
            <span class="text-blue-500">•</span> <strong><%= cycle.name %>:</strong> <%= cycle.description %>
          </li>
        <% end %>
      </ul>
    </div>
  </div>

<% when 'program' %>
  <% if @selected_cycle %>
    <% cycle = @program.workout_cycles.find_by(name: @selected_cycle) %>
    <% if cycle %>
      <div class="space-y-6">
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
          <h3 class="font-semibold text-lg text-blue-800"><%= cycle.name %></h3>
          <p class="text-blue-700 text-sm mt-1"><%= cycle.description %></p>
        </div>
        
        <div class="grid gap-6">
          <% cycle.workout_sessions.each do |session| %>
            <div class="border rounded-lg p-6">
              <h4 class="font-semibold text-lg mb-2"><%= session.name %></h4>
              
              <div class="space-y-3">
                <% session.workout_exercises.order(:order_position).includes(:exercise).each do |workout_exercise| %>
                  <div class="flex items-center justify-between py-3 px-4 <%= workout_exercise.main? ? 'bg-blue-50 border-l-4 border-blue-400' : 'bg-gray-50' %> rounded-lg">
                    <div class="flex-1">
                      <!-- Exercise name with substitution dropdown -->
                      <div class="font-medium mb-1">
                        <%= render 'programs/components/exercise_substitution_dropdown', 
                              exercise: workout_exercise.exercise, 
                              original_name: workout_exercise.exercise.name,
                              user_equipment: @selected_equipment || Exercise::VALID_EQUIPMENT %>
                      </div>
                      
                      <% if workout_exercise.notes.present? %>
                        <div class="text-gray-500 text-sm">
                          <% if workout_exercise.notes.include?("×") || workout_exercise.notes.include?("x") %>
                            <!-- Notes contain sets/reps info -->
                            <%= workout_exercise.notes %>
                          <% else %>
                            <!-- Regular notes -->
                            <%= workout_exercise.notes %>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                    <div class="text-right">
                      <div class="font-medium text-lg">
                        <% if workout_exercise.sets.present? && workout_exercise.reps.present? %>
                          <%= workout_exercise.sets %> × <%= workout_exercise.reps %>
                        <% elsif workout_exercise.notes.present? %>
                          <% # Parse notes format: "2×5 - + AMRAP - Main strength movement" %>
                          <% note_parts = workout_exercise.notes.split(' - ') %>
                          <% sets_part = note_parts[0] %>
                          <% reps_part = note_parts[1] %>
                          
                          <% if sets_part.present? && reps_part.present? %>
                            <!-- Display sets and reps from the structured notes -->
                            <%= sets_part %> <%= reps_part %>
                          <% else %>
                            <!-- Try to parse other formats like "3 sets of 8" or standalone numbers -->
                            <% sets_reps = workout_exercise.notes.match(/(\d+)\s*[×x]\s*(\d+)/) %>
                            <% if sets_reps %>
                              <%= sets_reps[1] %> × <%= sets_reps[2] %>
                            <% elsif workout_exercise.notes.match(/(\d+)[\s-]+sets/i) %>
                              <%= workout_exercise.notes.match(/(\d+)[\s-]+sets/i)[1] %> sets
                            <% elsif workout_exercise.notes.match(/(\d+[\s-]*\d*)[\s-]+reps?/i) %>
                              <%= workout_exercise.notes.match(/(\d+[\s-]*\d*)[\s-]+reps?/i)[1] %> reps
                            <% elsif workout_exercise.notes.match(/^\d+$/) %>
                              <%= workout_exercise.notes %> reps
                            <% else %>
                              <span class="text-sm text-gray-600">See notes</span>
                            <% end %>
                          <% end %>
                        <% else %>
                          <span class="text-sm text-gray-500">—</span>
                        <% end %>
                      </div>
                      <% if workout_exercise.main? %>
                        <span class="text-xs text-blue-600 uppercase font-semibold">Main</span>
                      <% else %>
                        <span class="text-xs text-gray-500 uppercase">Accessory</span>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="text-center py-8">
        <p class="text-gray-500">Cycle not found.</p>
      </div>
    <% end %>
  <% else %>
    <div class="text-center py-8">
      <p class="text-gray-500">Select a cycle to view the program.</p>
    </div>
  <% end %>

<% when 'schedule' %>
  <div class="space-y-6">
    <h3 class="font-semibold text-lg mb-4">Weekly Schedule</h3>
    
    <% @program.workout_cycles.each_with_index do |cycle, cycle_index| %>
      <div class="border rounded-lg p-4 mb-4">
        <h4 class="font-medium text-lg mb-3">
          Cycle <%= cycle_index + 1 %>: <%= cycle.name %>
        </h4>
        <p class="text-gray-600 text-sm mb-4"><%= cycle.description %></p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          <% cycle.workout_sessions.each do |session| %>
            <div class="bg-gray-50 rounded p-3">
              <h5 class="font-medium text-sm mb-1"><%= session.name %></h5>
              <p class="text-xs text-gray-700"><%= pluralize(session.workout_exercises.count, 'exercise') %></p>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

<% else %>
  <div class="text-center py-8">
    <p class="text-gray-500">Select a view mode to see content.</p>
  </div>
<% end %>